@model seashore_CRM.Models.DTOs.LeadDto

@{
    ViewData["Title"] = "Create Lead";
}

<h1>Create Lead</h1>

<form asp-action="Create" method="post" enctype="multipart/form-data">
    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label asp-for="LeadType" class="form-label">Lead Type</label>
                <div>
                    <input type="radio" asp-for="LeadType" value="Corporate" /> Corporate
                    <input type="radio" asp-for="LeadType" value="Individual" /> Individual
                </div>
            </div>

            <div class="mb-3">
                <label asp-for="CompanyId" class="form-label">Company</label>
                <select asp-for="CompanyId" class="form-control" asp-items="ViewBag.Companies">
                    <option value="">-- Select Company --</option>
                </select>
            </div>

            <div class="mb-3">
                <label asp-for="ContactId" class="form-label">Contact</label>
                <select asp-for="ContactId" class="form-control" asp-items="ViewBag.Contacts">
                    <option value="">-- Select Contact --</option>
                </select>
            </div>

            <div class="mb-3">
                <label asp-for="SourceId" class="form-label">Source</label>
                <select asp-for="SourceId" class="form-control" asp-items="ViewBag.Sources">
                    <option value="">-- Select Source --</option>
                </select>
            </div>

            <div class="mb-3">
                <label asp-for="StatusId" class="form-label">Status</label>
                <select asp-for="StatusId" class="form-control" asp-items="ViewBag.Statuses" id="statusSelect">
                    <option value="">-- Select Status --</option>
                </select>
            </div>

            <div class="mb-3">
                <label asp-for="Priority" class="form-label">Priority</label>
                <div>
                    <button type="button" class="btn btn-danger btn-sm priority-btn">Hot</button>
                    <button type="button" class="btn btn-warning btn-sm priority-btn">Warm</button>
                    <button type="button" class="btn btn-success btn-sm priority-btn">Cold</button>
                </div>
                <input asp-for="Priority" type="hidden" />
            </div>

            <div class="mb-3">
                <label asp-for="AssignedUserId" class="form-label">Assigned User</label>
                <select asp-for="AssignedUserId" class="form-control" asp-items="ViewBag.Users">
                    <option value="">-- Select User --</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">Attach Files</label>
                <input type="file" name="files" multiple class="form-control" />
            </div>

            <!-- container for selected activities to be posted -->
            <div id="selectedActivitiesContainer"></div>
        </div>

        <div class="col-md-6">
            <h5>Product Items</h5>
            <table class="table" id="productTable">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Qty</th>
                        <th>Unit Price</th>
                        <th>Tax %</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <select class="form-control product-select" name="ProductItems[0].ProductId">
                                <option value="">-- Select Product --</option>
                                @foreach (var p in ViewBag.ProductList)
                                {
                                    <option value="@p.Value">@p.Text</option>
                                }
                            </select>
                        </td>
                        <td><input class="form-control" name="ProductItems[0].Quantity" value="1" /></td>
                        <td><input class="form-control" name="ProductItems[0].UnitPrice" value="0" /></td>
                        <td><input class="form-control" name="ProductItems[0].TaxPercentage" value="0" /></td>
                        <td><button type="button" class="btn btn-sm btn-danger remove-row">Remove</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" id="addProduct" class="btn btn-sm btn-primary">Add Product Row</button>

            <div class="mt-4">
                <h5>Suggested Activities</h5>
                <div id="suggestedActivitiesArea">
                    <p class="text-muted">Select a status to see suggested activities.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <button type="submit" class="btn btn-success">Save Lead</button>
        <a asp-action="Index" class="btn btn-secondary">Cancel</a>
    </div>
</form>

@section Scripts {
    <script>
        (function(){
            let idx = 1;
            $('#addProduct').on('click', function(){
                const row = `<tr>
                        <td>
                            <select class="form-control product-select" name="ProductItems[${idx}].ProductId">
                                <option value="">-- Select Product --</option>
                                @foreach (var p in ViewBag.ProductList)
                                {
                                    <text><option value="@p.Value">@p.Text</option></text>
                                }
                            </select>
                        </td>
                        <td><input class="form-control" name="ProductItems[${idx}].Quantity" value="1" /></td>
                        <td><input class="form-control" name="ProductItems[${idx}].UnitPrice" value="0" /></td>
                        <td><input class="form-control" name="ProductItems[${idx}].TaxPercentage" value="0" /></td>
                        <td><button type="button" class="btn btn-sm btn-danger remove-row">Remove</button></td>
                    </tr>`;
                $('#productTable tbody').append(row);
                idx++;
            });

            $(document).on('click', '.remove-row', function(){
                $(this).closest('tr').remove();
            });

            $('.priority-btn').click(function(){
                $('.priority-btn').removeClass('selected');
                $(this).addClass('selected');
                $('input[name="Priority"]').val($(this).text());
            });

            // Status -> suggested activities wiring
            const mapping = @Html.Raw(ViewBag.StatusActivitiesJson ?? "{}");

            function renderSuggested(statusId) {
                const area = $('#suggestedActivitiesArea');
                area.empty();
                if (!statusId) {
                    area.append('<p class="text-muted">Select a status to see suggested activities.</p>');
                    return;
                }

                // find status name from select option
                const statusText = $('#statusSelect option:selected').text();
                const activities = mapping[statusText];
                if (!activities || activities.length === 0) {
                    area.append('<p class="text-muted">No suggested activities for this status.</p>');
                    return;
                }

                const list = $('<div class="d-flex flex-wrap"></div>');
                activities.forEach(function(a, i){
                    const id = 'act_' + i;
                    const btn = $(`<div class="m-1"><label class="btn btn-outline-primary btn-sm"><input type="checkbox" class="activity-checkbox" value="${a}" /> ${a}</label></div>`);
                    list.append(btn);
                });
                area.append(list);

                // when any checkbox changes, ensure hidden inputs are updated
                $('.activity-checkbox').on('change', function(){
                    $('#selectedActivitiesContainer').empty();
                    $('.activity-checkbox:checked').each(function(i, el){
                        const val = $(el).val();
                        $('#selectedActivitiesContainer').append(`<input type="hidden" name="SelectedActivities" value="${val}" />`);
                    });
                });
            }

            $('#statusSelect').on('change', function(){
                renderSuggested($(this).val());
            });

            // initial render if a status preselected
            renderSuggested($('#statusSelect').val());

        })();
    </script>
}