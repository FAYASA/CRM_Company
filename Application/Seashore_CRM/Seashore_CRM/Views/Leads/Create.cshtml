@model seashore_CRM.Models.DTOs.LeadDto
@{
    ViewData["Title"] = "Create Lead";
}

<form asp-action="Create" method="post" enctype="multipart/form-data">
    <div class="container-fluid py-4">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Create Lead</h5>
                <small>Lead Management System</small>
            </div>
            <div class="card-body">
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Lead Type</label><br />
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" asp-for="LeadType" value="Corporate" id="leadCorporate" checked>
                            <label class="form-check-label" for="leadCorporate">Corporate</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" asp-for="LeadType" value="Individual" id="leadIndividual">
                            <label class="form-check-label" for="leadIndividual">Individual</label>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-bold">Company</label>
                        <select asp-for="CompanyId" class="form-select" asp-items="ViewBag.Companies" id="companySelect">
                            <option value="">-- Select Company --</option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-bold">Contact</label>
                        <select asp-for="ContactId" class="form-select" asp-items="ViewBag.Contacts">
                            <option value="">-- Select Contact --</option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-bold">Source</label>
                        <select asp-for="SourceId" class="form-select" asp-items="ViewBag.Sources">
                            <option value="">-- Select Source --</option>
                        </select>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label fw-bold">Status</label>
                        <select asp-for="StatusId" class="form-select" asp-items="ViewBag.Statuses" id="statusSelect">
                            <option value="">-- Select Status --</option>
                        </select>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label fw-bold">Priority</label>
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-outline-danger btn-sm priority-btn" data-val="Hot">Hot</button>
                            <button type="button" class="btn btn-outline-warning btn-sm priority-btn" data-val="Warm">Warm</button>
                            <button type="button" class="btn btn-outline-success btn-sm priority-btn" data-val="Cold">Cold</button>
                        </div>
                        <input asp-for="Priority" type="hidden" id="priorityHidden" />
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-bold">Assigned User</label>
                        <select asp-for="AssignedUserId" class="form-select" asp-items="ViewBag.Users">
                            <option value="">-- Select User --</option>
                        </select>
                    </div>

                    <div class="col-md-5">
                        <label class="form-label fw-bold">Attach Files</label>
                        <input type="file" name="files" class="form-control" multiple>
                    </div>
                </div>

                <hr />

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="fw-bold mb-0 text-primary"><i class="bi bi-box-seam me-2"></i>Product Items</h6>
                    <button type="button" class="btn btn-sm btn-success" id="addProduct">
                        <i class="bi bi-plus-lg"></i> Add Product Row
                    </button>
                </div>

                <div class="table-responsive">
                    <table class="table table-bordered table-hover align-middle" id="productTable" style="min-width: 1300px;">
                        <thead class="table-light text-secondary small text-uppercase text-center">
                            <tr>
                                <th style="width: 150px;">Category</th>
                                <th style="width: 130px;">Pro. Group</th>
                                <th style="width: 180px;">Product Title</th>
                                <th style="width: 80px;">Qty</th>
                                <th style="width: 100px;">Unit Price</th>
                                <th style="width: 100px;">Sale Value</th>
                                <th style="width: 90px;">Tax %</th>
                                <th style="width: 100px;">Tax Val</th>
                                <th style="width: 110px;">Gross Total</th>
                                <th style="width: 100px;">Cost</th>
                                <th style="width: 100px;">Profit</th>
                                <th style="width: 50px;"></th>
                            </tr>
                        </thead>
                        <tbody id="productBody">
                            <tr class="product-row">
                                <td>
                                    <select class="form-select form-select-sm category-select" name="ProductItems[0].CategoryId">
                                        <option value="">--</option>
                                        @foreach (var c in ViewBag.Categories as SelectList)
                                        {
                                            <option value="@c.Value">@c.Text</option>
                                        }
                                    </select>
                                </td>
                                <td><input type="text" class="form-control form-control-sm" name="ProductItems[0].ProductGroup" /></td>
                                <td>
                                    <select class="form-select form-select-sm product-select" name="ProductItems[0].ProductId">
                                        <option value="">-- Select Product --</option>
                                        @foreach (var p in ViewBag.ProductList)
                                        {
                                            <option value="@p.Value">@p.Text</option>
                                        }
                                    </select>
                                </td>
                                <td><input type="number" class="form-control form-control-sm qty" name="ProductItems[0].Quantity" value="0" /></td>
                                <td><input type="number" class="form-control form-control-sm unitprice" name="ProductItems[0].UnitPrice" value="0" /></td>
                                <td><input type="text" class="form-control form-control-sm bg-light salevalue" name="ProductItems[0].SaleValue" value="0.00" readonly /></td>
                                <td>
                                    <select class="form-select form-select-sm taxpct" name="ProductItems[0].TaxPercentage">
                                        <option value="0">0</option>
                                        <option value="5">5</option>
                                        <option value="10">10</option>
                                        <option value="15">15</option>
                                    </select>
                                </td>
                                <td><input type="text" class="form-control form-control-sm bg-light taxvalue" name="ProductItems[0].TaxValue" value="0.00" readonly /></td>
                                <td><input type="text" class="form-control form-control-sm bg-light gtotal" name="ProductItems[0].GrossTotal" value="0.00" readonly /></td>
                                <td><input type="number" class="form-control form-control-sm cost" name="ProductItems[0].Cost" value="0" /></td>
                                <td><input type="text" class="form-control form-control-sm bg-light grossprofit" name="ProductItems[0].GrossProfit" value="0.00" readonly /></td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-link text-danger p-0 remove-row"><i class="bi bi-trash"></i></button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div id="selectedActivitiesContainer"></div>

                <div class="row mt-4 g-4">
                    <div class="col-md-6">
                        <label class="fw-bold mb-2">Suggested Activities</label>
                        <div id="suggestedActivitiesArea" class="p-3 border rounded bg-light min-vh-10">
                            <p class="text-muted mb-0">Select a status to see suggested activities.</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="fw-bold mb-2">Comments</label>
                        <select id="commentTemplate" class="form-select form-select-sm mb-2">
                            <option value="">-- Select Template --</option>
                            @foreach (var t in ViewBag.CommentTemplates as SelectList)
                            {
                                <option value="@t.Value">@t.Text</option>
                            }
                        </select>
                        <textarea id="comments" name="Comments" class="form-control" rows="3" placeholder="Make Your Comments Here"></textarea>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-light text-end py-3">
                <a asp-action="Index" class="btn btn-outline-secondary px-4 me-2">Cancel</a>
                <button type="submit" class="btn btn-success px-5 shadow-sm">Save Lead</button>
            </div>
        </div>
    </div>
</form>

@section Scripts {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script>
        $(document).ready(function () {
            let idx = 1;
            const productsMap = @Html.Raw(ViewBag.ProductsJson ?? "{}");
            const statusMapping = @Html.Raw(ViewBag.StatusActivitiesJson ?? "{}");

            // 1. Lead Type Toggle (Company Select)
            function toggleCompanySelect() {
                if ($('#leadCorporate').is(':checked')) {
                    $('#companySelect').prop('disabled', false);
                } else {
                    $('#companySelect').prop('disabled', true).val("");
                }
            }
            $('input[name="LeadType"]').on('change', toggleCompanySelect);
            toggleCompanySelect();

            // 2. Priority Buttons
            $('.priority-btn').click(function () {
                $('.priority-btn').removeClass('active btn-danger btn-warning btn-success').addClass('btn-outline-secondary');
                const val = $(this).data('val');
                $(this).addClass('active');
                if(val === 'Hot') $(this).removeClass('btn-outline-secondary').addClass('btn-danger');
                if(val === 'Warm') $(this).removeClass('btn-outline-secondary').addClass('btn-warning');
                if(val === 'Cold') $(this).removeClass('btn-outline-secondary').addClass('btn-success');
                $('#priorityHidden').val(val);
            });

            // 3. Add Product Row
            $('#addProduct').on('click', function () {
                const row = $('.product-row').first().clone();
                row.find('input').val(0);
                row.find('input[readonly]').val('0.00');
                row.find('select').val("");

                // Update names for indexing
                row.find('[name]').each(function() {
                    let name = $(this).attr('name');
                    $(this).attr('name', name.replace(/\[\d+\]/, `[${idx}]`));
                });

                $('#productBody').append(row);
                idx++;
            });

            $(document).on('click', '.remove-row', function () {
                if ($('.product-row').length > 1) $(this).closest('tr').remove();
            });

            // 4. Calculations
            $(document).on('change', '.product-select', function () {
                const val = $(this).val();
                const tr = $(this).closest('tr');
                if (val && productsMap[val]) {
                    tr.find('.unitprice').val(productsMap[val].unitPrice);
                    tr.find('.cost').val(productsMap[val].cost);
                    tr.find('.taxpct').val(productsMap[val].tax);
                    tr.find('.category-select').val(productsMap[val].categoryId || '');
                }
                recalcRow(tr);
            });

            $(document).on('input change', '.qty, .unitprice, .taxpct, .cost', function () {
                recalcRow($(this).closest('tr'));
            });

            function recalcRow(tr) {
                const qty = parseFloat(tr.find('.qty').val() || 0);
                const unit = parseFloat(tr.find('.unitprice').val() || 0);
                const taxPct = parseFloat(tr.find('.taxpct').val() || 0);
                const cost = parseFloat(tr.find('.cost').val() || 0);

                const sale = qty * unit;
                const taxVal = sale * (taxPct / 100.0);
                const gross = sale + taxVal;
                const profit = sale - (cost * qty);

                tr.find('.salevalue').val(sale.toFixed(2));
                tr.find('.taxvalue').val(taxVal.toFixed(2));
                tr.find('.gtotal').val(gross.toFixed(2));
                tr.find('.grossprofit').val(profit.toFixed(2));
            }

            // 5. Suggested Activities
            $('#statusSelect').on('change', function () {
                const area = $('#suggestedActivitiesArea');
                const statusText = $("#statusSelect option:selected").text();
                const activities = statusMapping[statusText];

                area.empty();
                $('#selectedActivitiesContainer').empty();

                if (activities && activities.length > 0) {
                    let html = '<div class="d-flex flex-wrap">';
                    activities.forEach(a => {
                        html += `<div class="m-1"><input type="checkbox" class="btn-check activity-checkbox" id="btn_${a}" value="${a}" autocomplete="off">
                                 <label class="btn btn-outline-primary btn-sm" for="btn_${a}">${a}</label></div>`;
                    });
                    html += '</div>';
                    area.append(html);
                } else {
                    area.append('<p class="text-muted mb-0">No activities for this status.</p>');
                }
            });

            $(document).on('change', '.activity-checkbox', function() {
                $('#selectedActivitiesContainer').empty();
                $('.activity-checkbox:checked').each(function() {
                    $('#selectedActivitiesContainer').append(`<input type="hidden" name="SelectedActivities" value="${$(this).val()}" />`);
                });
            });

            // 6. Comment Templates
            $('#commentTemplate').on('change', function () {
                const val = $(this).find("option:selected").text();
                if ($(this).val()) {
                    const cur = $('#comments').val();
                    $('#comments').val((cur ? cur + "\n" : "") + val);
                    $(this).val("");
                }
            });
        });
    </script>
}