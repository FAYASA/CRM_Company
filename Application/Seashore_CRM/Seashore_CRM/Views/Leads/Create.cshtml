@model seashore_CRM.Models.DTOs.LeadDto
@{
    ViewData["Title"] = "Create Lead";
}

@await Html.PartialAsync("_PageHeader")

<form asp-action="Create" method="post" enctype="multipart/form-data" class="mt-3 pb-5">
    @Html.AntiForgeryToken()
    <div class="container-fluid px-4">

        <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
            <h4 class="text-primary fw-bold mb-0">Create New Lead</h4>
            <div>
                <a asp-action="Index" class="btn btn-outline-secondary btn-sm px-3 me-2">Cancel</a>
                <button type="submit" class="btn btn-primary btn-sm px-4 fw-bold shadow-sm">Save Lead</button>
            </div>
        </div>

        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white py-3">
                <h6 class="text-uppercase fw-bold text-secondary mb-0" style="font-size: 0.8rem; letter-spacing: 1px;">General Information</h6>
            </div>
            <div class="card-body bg-light-subtle">
                <div class="row g-3 align-items-end">
                    <div class="col-md-2">
                        <label class="form-label small fw-bold text-muted text-uppercase">Lead Type</label>
                        <div class="d-flex align-items-center gap-3 form-control form-control-sm bg-white" style="height: 31px;">
                            <div class="form-check mb-0">
                                <input class="form-check-input" type="radio" asp-for="LeadType" value="Corporate" id="leadCorporate" checked>
                                <label class="form-check-label small" for="leadCorporate">Corp</label>
                            </div>
                            <div class="form-check mb-0">
                                <input class="form-check-input" type="radio" asp-for="LeadType" value="Individual" id="leadIndividual">
                                <label class="form-check-label small" for="leadIndividual">Indiv</label>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label small fw-bold text-muted text-uppercase">Company <a href="@Url.Action("Create","Companies")" target="_blank" class="ms-2 small text-primary">+ New</a></label>
                        <select asp-for="CompanyId" class="form-select form-select-sm shadow-sm" asp-items="ViewBag.Companies" id="companySelect">
                            <option value="">-- Select Company --</option>
                        </select>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label small fw-bold text-muted text-uppercase">Contact <a href="@Url.Action("Create","Contacts")" target="_blank" class="ms-2 small text-primary">+ New</a></label>
                        <select asp-for="ContactId" class="form-select form-select-sm shadow-sm" asp-items="ViewBag.Contacts">
                            <option value="">-- Select Contact --</option>
                        </select>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label small fw-bold text-muted text-uppercase">Source</label>
                        <select asp-for="SourceId" class="form-select form-select-sm shadow-sm" asp-items="ViewBag.Sources">
                            <option value="">-- Select Source --</option>
                        </select>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label small fw-bold text-muted text-uppercase">Status <a href="#" id="addStatusActivityBtn" class="ms-2 small text-primary">+ New Activity</a></label>
                        <select asp-for="StatusId" class="form-select form-select-sm shadow-sm border-primary" asp-items="ViewBag.Statuses" id="statusSelect">
                            <option value="">-- Select Status --</option>
                        </select>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label small fw-bold text-muted text-uppercase">Priority</label>
                        <div class="btn-group w-100 shadow-sm" role="group">
                            <button type="button" class="btn btn-outline-danger btn-sm priority-btn" data-val="Hot">Hot</button>
                            <button type="button" class="btn btn-outline-warning btn-sm priority-btn" data-val="Warm">Warm</button>
                            <button type="button" class="btn btn-outline-success btn-sm priority-btn" data-val="Cold">Cold</button>
                        </div>
                        <input asp-for="Priority" type="hidden" id="priorityHidden" />
                    </div>
                </div>

                <div class="row g-3 mt-1">
                    <div class="col-md-2">
                        <label class="form-label small fw-bold text-muted text-uppercase">Assigned User</label>
                        <select asp-for="AssignedUserId" class="form-select form-select-sm shadow-sm" asp-items="ViewBag.Users">
                            <option value="">-- Select User --</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small fw-bold text-muted text-uppercase">Attach Files</label>
                        <input type="file" name="files" class="form-control form-control-sm shadow-sm" multiple>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-md-6">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-white py-2">
                        <span class="small fw-bold text-muted text-uppercase">Suggested Activities</span>
                    </div>
                    <div class="card-body" id="suggestedActivitiesArea">
                        <p class="text-muted small mb-0">Select a lead status to view suggestions.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                        <span class="small fw-bold text-muted text-uppercase">Comments & Notes</span>
                        <select id="commentTemplate" class="form-select form-select-sm w-auto border-0 text-primary fw-bold">
                            <option value="">Quick Templates</option>
                            @foreach (var t in ViewBag.CommentTemplates as SelectList)
                            {
                                <option value="@t.Value">@t.Text</option>
                            }
                        </select>
                    </div>
                    <div class="card-body p-0">
                        <textarea id="comments" name="Comments" class="form-control border-0 rounded-0" rows="4" placeholder="Type notes here..."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div id="selectedActivitiesContainer"></div>



        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="text-uppercase fw-bold text-secondary mb-0" style="font-size: 0.8rem; letter-spacing: 1px;">Product Details</h6>
            <button type="button" class="btn btn-success btn-sm px-3 shadow-sm" id="addProduct">
                <i class="bi bi-plus-lg"></i> Add Row
            </button>
        </div>

        <div class="table-responsive shadow-sm rounded border bg-white mb-4">
            <table class="table table-sm table-hover align-middle mb-0" id="productTable" style="min-width: 1200px;">
                <thead class="bg-light text-muted small text-uppercase">
                    <tr>
                        <th class="ps-3" style="width: 140px;">Category</th>
                        <th style="width: 180px;">Product Name</th>
                        <th class="text-center" style="width: 70px;">Qty</th>
                        <th class="text-end" style="width: 100px;">Price</th>
                        <th class="text-end" style="width: 100px;">Sale Val</th>
                        <th class="text-center" style="width: 80px;">Tax %</th>
                        <th class="text-end" style="width: 100px;">Tax Val</th>
                        <th class="text-end" style="width: 110px;">Total</th>
                        <th class="text-end" style="width: 100px;">Cost</th>
                        <th class="text-end" style="width: 100px;">Profit</th>
                        <th style="width: 40px;"></th>
                    </tr>
                </thead>
                <tbody id="productBody border-top-0">
                    <tr class="product-row">
                        <td class="ps-3">
                            <select class="form-select form-select-sm border-0 bg-transparent category-select" name="ProductItems[0].CategoryId">
                                <option value="">--</option>
                                @foreach (var c in ViewBag.Categories as SelectList)
                                {
                                    <option value="@c.Value">@c.Text</option>
                                }
                            </select>
                        </td>
                        <td>
                            <select class="form-select form-select-sm border-0 bg-transparent product-select fw-bold text-primary" name="ProductItems[0].ProductId">
                                <option value="">-- Select --</option>
                                @foreach (var p in ViewBag.ProductList)
                                {
                                    <option value="@p.Value">@p.Text</option>
                                }
                            </select>
                        </td>
                        <td><input type="number" class="form-control form-control-sm border-0 bg-transparent text-center qty" name="ProductItems[0].Quantity" value="1" /></td>
                        <td><input type="number" class="form-control form-control-sm border-0 bg-transparent text-end unitprice" name="ProductItems[0].UnitPrice" value="0" /></td>
                        <td><input type="text" class="form-control form-control-sm border-0 bg-light text-end salevalue" name="ProductItems[0].SaleValue" readonly /></td>
                        <td>
                            <select class="form-select form-select-sm border-0 bg-transparent text-center taxpct" name="ProductItems[0].TaxPercentage">
                                <option value="0">0</option>
                                <option value="5">5</option>
                                <option value="15">15</option>
                            </select>
                        </td>
                        <td><input type="text" class="form-control form-control-sm border-0 bg-light text-end taxvalue" name="ProductItems[0].TaxValue" readonly /></td>
                        <td><input type="text" class="form-control form-control-sm border-0 bg-light text-end fw-bold gtotal" name="ProductItems[0].GrossTotal" readonly /></td>
                        <td><input type="number" class="form-control form-control-sm border-0 bg-transparent text-end cost" name="ProductItems[0].Cost" value="0" /></td>
                        <td><input type="text" class="form-control form-control-sm border-0 bg-light text-end fw-bold grossprofit" name="ProductItems[0].GrossProfit" readonly /></td>
                        <td class="text-center">
                            <button type="button" class="btn btn-link text-danger p-0 remove-row"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>
</form>

<!-- Modal to create a new activity name for selected status -->
<div class="modal fade" id="addActivityModal" tabindex="-1" aria-labelledby="addActivityModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addActivityModalLabel">Add Activity for Status</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Status</label>
          <input type="text" id="modalStatusName" class="form-control" readonly />
        </div>
        <div class="mb-3">
          <label class="form-label">Activity Name</label>
          <input type="text" id="newActivityName" class="form-control" />
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" id="saveActivityBtn" class="btn btn-primary">Save Activity</button>
      </div>
    </div>
  </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            let idx = 1;
            const productsMap = @Html.Raw(ViewBag.ProductsJson ?? "{}");
            let statusMapping = @Html.Raw(ViewBag.StatusActivitiesJson ?? "{}");

            // function to render suggested activities for currently selected status
            function renderSuggestedActivities() {
                const area = $('#suggestedActivitiesArea');
                area.empty();
                const statusText = $('#statusSelect option:selected').text();
                if (!statusText || statusText === '-- Select Status --') {
                    area.append('<p class="text-muted small mb-0">Select a lead status to view suggestions.</p>');
                    return;
                }
                const acts = statusMapping[statusText];
                if (acts && acts.length) {
                    acts.forEach(a => {
                        const idSafe = 'act_' + a.replace(/[^a-z0-9]/gi, '_');
                        area.append(`<div class="form-check form-check-inline">
                            <input type="checkbox" class="btn-check activity-chk" id="${idSafe}" value="${a}">
                            <label class="btn btn-outline-primary btn-sm rounded-pill px-3 mb-2" for="${idSafe}">${a}</label>
                        </div>`);
                    });
                } else {
                    area.append('<p class="text-muted small">No suggestions.</p>');
                }
            }

            // initial render
            renderSuggestedActivities();

            // 1. Lead Type Logic
            function toggleCompany() {
                $('#companySelect').prop('disabled', !$('#leadCorporate').is(':checked')).val("");
            }
            $('input[name="LeadType"]').on('change', toggleCompany);
            toggleCompany();

            // 2. Priority Button Group
            $('.priority-btn').click(function () {
                $('.priority-btn').removeClass('active btn-danger btn-warning btn-success').addClass('btn-outline-secondary');
                const val = $(this).data('val');
                $(this).addClass('active');
                if(val === 'Hot') $(this).removeClass('btn-outline-secondary').addClass('btn-danger');
                if(val === 'Warm') $(this).removeClass('btn-outline-secondary').addClass('btn-warning');
                if(val === 'Cold') $(this).removeClass('btn-outline-secondary').addClass('btn-success');
                $('#priorityHidden').val(val);
            });

            // 3. Dynamic Row Addition
            $('#addProduct').on('click', function () {
                const row = $('.product-row').first().clone();
                row.find('input').val(0);
                row.find('select').val("");
                row.find('[name]').each(function() {
                    $(this).attr('name', $(this).attr('name').replace(/\[\d+\]/, `[${idx}]`));
                });
                $('#productBody').append(row);
                idx++;
            });

            $(document).on('click', '.remove-row', function () {
                if ($('.product-row').length > 1) $(this).closest('tr').remove();
            });

            // 4. Calculations
            $(document).on('change', '.product-select', function () {
                const tr = $(this).closest('tr');
                const p = productsMap[$(this).val()];
                if (p) {
                    tr.find('.unitprice').val(p.unitPrice);
                    tr.find('.cost').val(p.cost);
                    tr.find('.taxpct').val(p.tax);
                    tr.find('.category-select').val(p.categoryId || '');
                }
                recalc(tr);
            });

            $(document).on('input change', '.qty, .unitprice, .taxpct, .cost', function () {
                recalc($(this).closest('tr'));
            });

            function recalc(tr) {
                const q = parseFloat(tr.find('.qty').val() || 0);
                const u = parseFloat(tr.find('.unitprice').val() || 0);
                const tP = parseFloat(tr.find('.taxpct').val() || 0);
                const c = parseFloat(tr.find('.cost').val() || 0);

                const s = q * u;
                const tV = s * (tP / 100);
                const g = s + tV;
                const p = s - (c * q);

                tr.find('.salevalue').val(s.toFixed(2));
                tr.find('.taxvalue').val(tV.toFixed(2));
                tr.find('.gtotal').val(g.toFixed(2));
                tr.find('.grossprofit').val(p.toFixed(2));
            }

            // 5. Activities
            $('#statusSelect').on('change', function () {
                renderSuggestedActivities();
            });

            $(document).on('change', '.activity-chk', function() {
                $('#selectedActivitiesContainer').empty();
                $('.activity-chk:checked').each(function() {
                    $('#selectedActivitiesContainer').append(`<input type="hidden" name="SelectedActivities" value="${$(this).val()}" />`);
                });
            });

            // open modal and prefill status name
            $('#addStatusActivityBtn').on('click', function(e){
                e.preventDefault();
                const statusText = $('#statusSelect option:selected').text();
                $('#modalStatusName').val(statusText);
                var modal = new bootstrap.Modal(document.getElementById('addActivityModal'));
                modal.show();
            });

            // save new activity via AJAX
            $('#saveActivityBtn').on('click', function(){
                const statusName = $('#modalStatusName').val();
                const activityName = $('#newActivityName').val();
                if (!statusName || statusName === '-- Select Status --') {
                    alert('Please select a status first.');
                    return;
                }
                if (!activityName || !activityName.trim()) {
                    alert('Enter activity name.');
                    return;
                }

                const token = $('input[name="__RequestVerificationToken"]').first().val();

                $.ajax({
                    url: '@Url.Action("AddStatusActivity","Leads")',
                    method: 'POST',
                    data: { statusName: statusName, activityName: activityName, __RequestVerificationToken: token },
                    success: function(resp) {
                        if (resp && resp.success) {
                            statusMapping = resp.mapping; // update local mapping
                            renderSuggestedActivities();
                            // close modal
                            var modalEl = document.getElementById('addActivityModal');
                            var bsModal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                            bsModal.hide();
                            $('#newActivityName').val('');
                        } else {
                            alert('Failed to add activity');
                        }
                    },
                    error: function() {
                        alert('Error while adding activity');
                    }
                });
            });

            // 6. Comments
            $('#commentTemplate').on('change', function () {
                const txt = $(this).find("option:selected").text();
                if ($(this).val()) {
                    const box = $('#comments');
                    box.val((box.val() ? box.val() + "\n" : "") + txt);
                    $(this).val("");
                }
            });
        });
    </script>
}